pipeline {
    agent any

    environment {
        IMAGE_NAME = 'priya123456/restapi'
        CONTAINER_NAME = 'restapi-container'
        PORT_MAPPING = '8081:7000'  // hostPort:containerPort
    }

    stages {

        stage("Checkout") {
            steps {
                checkout scm
                sh '''
                    echo "âœ… Source Code Checked Out in: $PWD"
                    ls -l
                '''
            }
        }

        stage("Build Application") {
            steps {
                sh '''
                    echo "ğŸš€ Building Java Application..."
                    mvn clean package -DskipTests
                    echo "âœ… Build completed!"
                '''
            }
        }

        stage("Test Application") {
            steps {
                sh '''
                    echo "ğŸ§ª Running Unit Tests..."
                    mvn test
                    echo "âœ… All tests completed!"
                '''
            }
        }

        stage("Build Docker Image") {
            steps {
                sh """
                    echo "ğŸ³ Building Docker Image..."
                    docker build -t ${IMAGE_NAME} .
                    echo "âœ… Docker Image Built: ${IMAGE_NAME}"
                """
            }
        }

        stage("Stop Old Container") {
            steps {
                sh """
                    echo "ğŸ›‘ Stopping old container (if exists)..."
                    docker stop ${CONTAINER_NAME} || true
                    docker rm ${CONTAINER_NAME} || true
                """
            }
        }

        stage("Run New Container") {
            steps {
                sh """
                    echo "ğŸš€ Running new container..."
                    docker run -d --name ${CONTAINER_NAME} -p ${PORT_MAPPING} ${IMAGE_NAME}
                    echo "ğŸ‰ Container started successfully!"
                """
            }
        }
    }
}
